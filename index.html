<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSU NCAR Ida Project</title>
    <link rel="stylesheet" href="styles/site.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    <script src="leaflet-side-by-side.js"></script>
    <script src="d3.v7.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="landing" class="textbox-background">
        <img src="images/background-1.jpg" alt="picture of coastal louisiana" />
        <div class="textbox-overlay">
            <h1>Social Responses to Climate Change Attributed Flooding in South Louisiana</h1>
            <p>Kevin Smiley, ... list contributors to study here</p>
            <p>Louisiana State University, NSF NCAR, the Water Institute ...</p>
        </div>
    </div>

    <div id="intro" class="textbox-main">
        <div class="text">
            <h2>What is attribution?</h2>
            <p>When talking about climate, attribution refers to .... [text introduction explaining what attribution is / how it works] Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo ...</p>
            <h2>An example of attribution</h2>
            <img src="images/placeholder-1.png" alt="example graph" />
            <p>In the graphs above, we're looking at [explanation and context as needed]. For example, on the left, the graph expresses that in [scenario 1], we attribute [$ amount or buildings damaged] to storm surge damages ...</p>
        </div>
    </div>


    <div class="textbox-background">
        <img src="images/background-2.jpg" alt="picture of coastal louisiana" />
        <div class="textbox-overlay">
            <h2>Impacts across space</h2>
            <p>One thing we can do in our study is to see how these impacts from climate change can really vary from place to place.</p>
        </div>
    </div>

    <div class="visualization-container">
        <div class="visualization-prompt">
            <h2 class="poppins-light">What might 
    
                <div class="dropdown">
                    <button class="dropdown-button">
                      <span id="environmental-dropdown-value-1" class="dropdown-value">storm surge flood damages</span>
                      <span class="arrow"></span>
                    </button>
                    <div id="environmental1" class="environmental dropdown-content">
                        <span id="wind-damages-1">wind damages</span>
                        <span class="selected-option" id="storm-surge-1">storm surge flood damages</span>
                    </div>
                </div>
                
                look like in
            
                <div class="dropdown">
                    <button class="dropdown-button">
                    <span id="years-dropdown-value-1" class="dropdown-value">1971</span>
                    <span class="arrow"></span>
                    </button>
                    <div id="year1" class="dropdown-content">
                        <span id="1971-1" class="selected-option">1971</span>
                        <span id="2021-1">2021</span>
                        <span id="2071-1">2071</span>
                    </div>
                </div>
                
                compared to in
    
                <div class="dropdown">
                    <button class="dropdown-button">
                    <span id="years-dropdown-value-2" class="dropdown-value">2021</span>
                    <span class="arrow"></span>
                    </button>
                    <div id="year2" class="dropdown-content">
                        <span id="1971-2">1971</span>
                        <span id="2021-2" class="selected-option">2021</span>
                        <span id="2071-2">2071</span>
                    </div>
                </div>
                ?
            </h2>
        </div>

        <div id="map-1" class="map">
        </div>
    </div>

    <div class="textbox-background">
        <img src="images/background-3.jpg" alt="picture of coastal louisiana" />
        <div class="textbox-overlay">
            <h2>Impacts across society</h2>
            <p>We can also learn about the social make-up of those affected places.</p>
        </div>
    </div>

    <div class="visualization-container">
        <div class="visualization-prompt">
            <h2 class="poppins-light">What might 
    
                <div class="dropdown">
                    <button class="dropdown-button">
                      <span id="environmental-dropdown-value-2" class="dropdown-value">storm surge flood damages</span>
                      <span class="arrow"></span>
                    </button>
                    <div id="environmental2" class="environmental dropdown-content">
                        <span id="wind-damages-2">wind damages</span>
                        <span class="selected-option" id="storm-surge-2">storm surge flood damages</span>
                    </div>
                </div>
                
            look like for people of different 
            
                <div class="dropdown">
                    <button class="dropdown-button">
                    <span id="social-dropdown-value" class="dropdown-value">incomes</span>
                    <span class="arrow"></span>
                    </button>
                    <div id="social2" class="social dropdown-content">
                        <span id="education-levels">education levels</span>
                        <span id="poverty-levels">poverty levels</span>
                        <span class="selected-option" id="incomes">incomes</span>
                    </div>
                </div>
                
                in
    
                <div class="dropdown">
                    <button class="dropdown-button">
                    <span id="years-dropdown-value-3" class="dropdown-value">2021</span>
                    <span class="arrow"></span>
                    </button>
                    <div id="year3" class="dropdown-content">
                        <span id="1971-3">1971</span>
                        <span id="2021-3" class="selected-option">2021</span>
                        <span id="2071-3">2071</span>
                    </div>
                </div>
                ?
            </h2>
        </div>
        
        <div id="map-2" class="map">
        </div>
    </div>

    <div class="textbox-background">
        <img src="images/background-4.jpg" alt="picture of coastal louisiana" />
        <div class="textbox-overlay">
            <h2>Conclusion</h2>
            <p>[conclusion content here] Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim...</p>
        </div>
    </div>
</body>
</html>

<script>
    // ------------ SETUP FOR MAP 1: COMPARING ONE ENVIRONMENTAL VARIABLE BETWEEN YEARS ------------
    var map = L.map('map-1', {
        minZoom: 7,
        maxZoom: 10,
        maxBounds: [
        [26, -100.5],
        [35, -82.5]
        ],
        maxBoundsViscosity: 1,
        bounceAtZoomLimits: false
    }).setView([30, -91.5], 8);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd'
    }).addTo(map);

    // properly center and expand map tiles on load
    setTimeout(function () {
        map.invalidateSize();
    }, 100);

    map.createPane("left")
    map.createPane("right")
    map.createPane("labels")

    // add labels layer on top
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        pane: 'labels'
    }).addTo(map);

    // ------------ SETUP FOR MAP 2: COMPARING ONE ENVIRONMENTAL VARIABLE WITH ONE SOCIAL VARIABLE IN ONE YEAR ------------
    var map2 = L.map('map-2', {
        minZoom: 7,
        maxZoom: 10,
        maxBounds: [
        [26, -100.5],
        [35, -82.5]
        ],
        maxBoundsViscosity: 1,
        bounceAtZoomLimits: false
    }).setView([30, -91.5], 8);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd'
    }).addTo(map2);

    // properly center and expand map tiles on load
    setTimeout(function () {
        map2.invalidateSize();
    }, 100);

    map2.createPane("left")
    map2.createPane("right")
    map2.createPane("labels")

    // add labels layer on top
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        pane: 'labels'
    }).addTo(map2);

    let year1Layer = null;
    let year2Layer = null;
    let socialLayer = null;
    let environmentalLayer2 = null;

     // referring to the options selected in the first visualization prompt
     const environmentalDropdown1 = document.querySelector('#environmental1');
    const yearDropdown1 = document.querySelector('#year1');
    const yearDropdown2 = document.querySelector('#year2');

    // let environmentalOptions1 = {"wind-damages-2" : "", "storm-surge-2" : ""};
    let yearOptions1 = {"1971-1" : "aff_1971", "2021-1": "aff_sum21", "2071-1": ""};
    let yearOptions2 = {"1971-2" : "aff_1971", "2021-2": "aff_sum21", "2071-2": ""};

    var yearLegend1;
    var yearLegend2;
    var comparator1;

    // referring to the options selected in the second visualization prompt
    const environmentalDropdown2 = document.querySelector('#environmental2');
    const socialDropdown = document.querySelector('#social2');
    const yearDropdown3 = document.querySelector('#year3');

    // let environmentalOptions2 = {"wind-damages-2" : "", "storm-surge-2" : ""};
    let socialOptions = {"racial-groups" : "", "education-levels" : "college_de", "poverty-levels" : "poverty_tr", "incomes" : "median_inc"}
    let yearOptions3 = {"1971-3" : "aff_1971", "2021-3": "aff_sum21", "2071-3": ""};

    var socialLegend;
    var environmentalLegend2;
    var comparator2;

    // ------------ DATA LAYER SETUP ------------
    async function loadTracts() {
        // loading in and drawing census tract boundaries      
        var currentSelectedLayer = null;
        const data = await d3.json("joined.geojson", d3.autoType);
        let features = data.features;

        // referring to selected options in first prompt
        const selectedEnvironmental1 = environmentalDropdown1.querySelector('.selected-option').id;
        const selectedYear1 = yearDropdown1.querySelector('.selected-option').id;
        const selectedYear2 = yearDropdown2.querySelector('.selected-option').id;

        const selectedYear1Property = yearOptions1[selectedYear1];
        let year1Extent = d3.extent(features, d => {if (d.properties["aff_sum21"]) return Number(d.properties["aff_sum21"])});
        let year1Colors = d3.scaleQuantile().domain(year1Extent).range(d3.schemeGnBu[8])

        const selectedYear2Property = yearOptions2[selectedYear2];
        let year2Extent = d3.extent(features, d => {if (d.properties["aff_sum21"]) return Number(d.properties["aff_sum21"])});
        let year2Colors = d3.scaleQuantile().domain(year2Extent).range(d3.schemeGnBu[8])

        // referring to selected options in second prompt
        const selectedEnvironmental2 = environmentalDropdown2.querySelector('.selected-option').id;
        const selectedSocial = socialDropdown.querySelector('.selected-option').id;
        const selectedYear3 = yearDropdown3.querySelector('.selected-option').id;

        const selectedSocialProperty = socialOptions[selectedSocial];
        let socialExtent = d3.extent(features, d => {if (d.properties[selectedSocialProperty]) return Number(d.properties[selectedSocialProperty])});
        let socialColors = d3.scaleQuantile().domain(socialExtent).range(d3.schemeYlOrBr[8])

        const selectedYear3Property = yearOptions3[selectedYear3];
        // let year3Extent = d3.extent(features, d => {if (d.properties[selectedYear3Property]) return Number(d.properties[selectedYear3Property])});
        // let year3Colors = d3.scaleQuantile().domain(year3Extent).range(d3.schemeGnBu[8])

        let year3Extent = d3.extent(features, d => {if (d.properties["aff_sum21"]) return Number(d.properties["aff_sum21"])});
        let year3Colors = d3.scaleQuantile().domain(year3Extent).range(d3.schemeGnBu[8])

        // function highlightFeature(e) {
        //     var layer = e.target;

        //     if (currentSelectedLayer) {
        //         if (currentSelectedLayer.defaultOptions.pane == 'left') {
        //             currentSelectedLayer.setStyle(environmentalStyle(currentSelectedLayer.feature));
        //         } else {
        //             currentSelectedLayer.setStyle(socialStyle(currentSelectedLayer.feature));
        //         }
        //     }

        //     layer.setStyle({
        //         weight: 5,             
        //         color: "#FF0000",    
        //         fillOpacity: 0.5 
        //     });

        //     currentSelectedLayer = layer;

        //     layer.on('popupclose', function() {
 
        // if (layer.defaultOptions.pane == 'left') {
        //     layer.setStyle(environmentalStyle(layer.feature));
        // } else {
        //     layer.setStyle(socialStyle(layer.feature));
        // }
        // });
        // }

        // function onEachFeature(feature, layer) {
        //     console.log(feature.properties)

        //     layer.bindPopup("<h3>" + 
        //         feature.properties.NAMELSADCO + 
        //         "</h3><p>Population: " + feature.properties.total_popu + 
        //             "</p><p> Median Income: " + feature.properties.median_inc + 
        //             "</p><p> College Educated: " + Math.round(feature.properties.college_de * 100) / 100 + 
        //             "</p><p> Poverty Rate: " + Math.round(feature.properties.poverty_tr * 100) / 100 + 
        //             "</p><p> White: " + Math.round(feature.properties.nhwhite_tr * 100) / 100 + 
        //             "</p><p> Black: " + Math.round(feature.properties.nhblack_tr * 100) / 100 + 
        //             "</p><p> Asian: " + Math.round(feature.properties.nhasian_tr * 100) / 100 +
        //             "</p><p> Hispanic: " + Math.round(feature.properties.hispanic_t * 100) / 100 + "</p>"

        //     );
        //     layer.on({
        //         click: highlightFeature
        //     });
        // }

        // styling functions for first map
        function year1Style(feature) {
            if (feature.properties[selectedYear1Property] === null) {
            return {
                color: 'lightgray', 
                weight: 0.5, 
                fillOpacity: 0.95,
                fillColor: 'lightgray' 
            };
        } else {
        return {
            color: 'white', 
            weight: 0.5, 
            fillOpacity: 0.95,
            fillColor: year1Colors(feature.properties[selectedYear1Property])
        };
        }
        }

        function year2Style(feature) {
            if (feature.properties[selectedYear2Property] === null) {
            return {
                color: 'lightgray', 
                weight: 0.5, 
                fillOpacity: 0.95,
                fillColor: 'lightgray' 
            };
        } else {
        return {
            color: 'white', 
            weight: 0.5, 
            fillOpacity: 0.95,
            fillColor: year2Colors(feature.properties[selectedYear2Property])
        };
        }
        }

        // styling functions for second map
        // function for styling social data layer
        function socialStyle(feature) {
            return {
                color: 'white',
                weight: 0.5,
                fillOpacity: 0.95,
                fillColor: socialColors(feature.properties[selectedSocialProperty])
            };
        }

        function environmentalStyle(feature) {
            if (feature.properties[selectedYear3Property] === null) {
            return {
                color: 'lightgray', 
                weight: 0.5, 
                fillOpacity: 0.95,
                fillColor: 'lightgray' 
            };
        } else {
        return {
            color: 'white', 
            weight: 0.5, 
            fillOpacity: 0.95,
            fillColor: year3Colors(feature.properties[selectedYear3Property])
        };
        }
        }

        // adding layers of first map
        year1Layer = L.geoJSON(data, 
            { 
                style: year1Style,
                // onEachFeature: onEachFeature,
                pane: 'left' 
            }
        ).addTo(this.map);

        year2Layer = L.geoJSON(data, 
            { 
                style: year2Style,
                // onEachFeature: onEachFeature,
                pane: 'right' 
            }
        ).addTo(this.map);


        // adding layers of second map
        socialLayer = L.geoJSON(data, 
            { 
                style: socialStyle,
                // onEachFeature: onEachFeature,
                pane: 'right' 
            }
        ).addTo(this.map2);

        environmentalLayer2 = L.geoJSON(data, 
            { 
                style: environmentalStyle,
                // onEachFeature: onEachFeature,
                pane: 'left' 
            }
        ).addTo(this.map2);

        if (!comparator1) {
            comparator1 = L.control.sideBySide([], []).addTo(this.map);
            comparator1.setLeftLayers(year1Layer);
            comparator1.setRightLayers(year2Layer)  
        }
        
        if (!comparator2) {
            comparator2 = L.control.sideBySide([], []).addTo(this.map2);
            comparator2.setLeftLayers(environmentalLayer2);
            comparator2.setRightLayers(socialLayer)  
        }
       
        // ------------ LEGEND SETUP -----------

        // setup for map 1
        if (yearLegend1) {
            map.removeControl(yearLegend1);
        };

        if (yearLegend2) {
            map.removeControl(yearLegend2);
        };

        yearLegend1 = L.control({position: 'bottomleft'});
        yearLegend2 = L.control({position: 'bottomright'});

        yearLegend1.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend'),
            classes = year1Colors.quantiles(),
            labels = [];
            
            div.innerHTML += '<p class="legend-title">Legend</p>'

            for (var i = 0; i < classes.length; i++) {
                var start = classes[i].toFixed(0);
            var end = classes[i + 1] ? classes[i + 1].toFixed(0) : "+";

            div.innerHTML +=
                '<i style="background:' + year1Colors(classes[i]) + '"></i> ' +
                start + (end !== "+" ? '&ndash;' + end : '') + '<br>';
            }
            return div;
        };

        yearLegend2.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend'),
            classes = year2Colors.quantiles(),
            labels = [];
            
            div.innerHTML += '<p class="legend-title">Legend</p>'

            for (var i = 0; i < classes.length; i++) {
                var start = classes[i].toFixed(0);
            var end = classes[i + 1] ? classes[i + 1].toFixed(0) : "+";

            div.innerHTML +=
                '<i style="background:' + year2Colors(classes[i]) + '"></i> ' +
                start + (end !== "+" ? '&ndash;' + end : '') + '<br>';
            }
            return div;
        };
        yearLegend1.addTo(map);
        yearLegend2.addTo(map);

        // setup for map 2
        if (socialLegend) {
            map2.removeControl(socialLegend);
        };

        if (environmentalLegend2) {
            map2.removeControl(environmentalLegend2);
        };
        
        socialLegend = L.control({position: 'bottomright'});
        environmentalLegend2 = L.control({position: 'bottomleft'});

        socialLegend.onAdd = function (map2) {
            var div = L.DomUtil.create('div', 'info legend'),
            classes = socialColors.quantiles(),
            labels = [];
            
            div.innerHTML += '<p class="legend-title">Legend</p>'

            for (var i = 0; i < classes.length; i++) {
                var start = classes[i].toFixed(2);
            var end = classes[i + 1] ? classes[i + 1].toFixed(2) : "+";

            div.innerHTML +=
                '<i style="background:' + socialColors(classes[i]) + '"></i> ' +
                start + (end !== "+" ? '&ndash;' + end : '') + '<br>';
            }
            return div;
        };

        environmentalLegend2.onAdd = function (map2) {
            var div = L.DomUtil.create('div', 'info legend'),
            classes = year3Colors.quantiles(),
            labels = [];
            
            div.innerHTML += '<p class="legend-title">Legend</p>'

            for (var i = 0; i < classes.length; i++) {
                var start = classes[i].toFixed(0);
            var end = classes[i + 1] ? classes[i + 1].toFixed(0) : "+";

            div.innerHTML +=
                '<i style="background:' + year3Colors(classes[i]) + '"></i> ' +
                start + (end !== "+" ? '&ndash;' + end : '') + '<br>';
            }
            return div;
        };
        socialLegend.addTo(map2);
        environmentalLegend2.addTo(map2);
    }
    loadTracts();


    // ------------ DROPDOWN INTERACTION SETUP ------------
    document.querySelectorAll('.dropdown').forEach(dropdown => {
        const dropdownButton = dropdown.querySelector('.dropdown-button');
        const dropdownContent = dropdown.querySelector('.dropdown-content');
        const dropdownOptions = [...dropdown.querySelectorAll('.dropdown-content span')];
        const dropdownArrow = dropdown.querySelector('.arrow');
        const dropdownValue = dropdown.querySelector('.dropdown-value');

        // Handling when dropdown filter chip is clicked
        dropdownButton.addEventListener('click', (event) => {
            const isVisible = dropdownContent.style.display === 'block';
            dropdownContent.style.display = isVisible ? 'none' : 'block';
            dropdownArrow.classList.toggle("active");
        });

        const setDropdownWidth = () => {
            const buttonWidth = dropdownButton.offsetWidth;
            dropdownContent.style.minWidth = `${buttonWidth}px`;
            dropdownContent.style.width = `${buttonWidth}px`;
        };

        addEventListener("load", function () {
            setDropdownWidth();
        })
       
        // Handling when a dropdown option is selected
        dropdownContent.addEventListener('click', (event) => {
            const target = event.target;
            if (target.tagName.toLowerCase() === 'span') {
                let newValue = target.innerHTML;
                dropdownValue.innerHTML = newValue;
                dropdownOptions.forEach((option) => option.classList.remove("selected-option"));
                target.classList.add("selected-option");
                setDropdownWidth();

                loadTracts();

                // socialLayer.setStyle(function(feature) {
                //     return socialStyle(feature, selectedProperty);
                // });

                // environmentalLayer2.setStyle(function(feature) {
                //     return environmentalStyle(feature, selectedProperty);
                // });
            }
        });

        // close dropdown if clicked outside
        window.addEventListener('click', (event) => {
            if (!dropdown.contains(event.target)) {
            if (dropdownContent.style.display === 'block') {
                dropdownContent.style.display = 'none';
                dropdownArrow.classList.remove("active");
            }
            }
        });
    });
</script>