<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSU NCAR Ida Project</title>
    <link rel="stylesheet" href="styles/site.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    <script src="leaflet-side-by-side.js"></script>
    <script src="d3.v7.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="landing" class="textbox-background">
        <img src="images/background-1.jpg" alt="picture of coastal louisiana" />
        <div class="textbox-overlay">
            <h1>Extreme Event Attribution of Hurricane Ida</h1>
            <p>Louisiana State University, the NSF National Center for Atmospheric Research, and the Water Institute</p>
        </div>
    </div>

    <div id="intro" class="textbox-main">
        <div class="text">
            <h2>What is Extreme Event Attribution?</h2>
            <p>The world is warming. We work in a field called extreme event attribution that investigates if the warming our world has already experienced&mdash;about 2 degrees Fahrenheit&mdash;is making our extreme weather more extreme. Our project studies Hurricane Ida, one of the United States' ten costliest storms ever and one with deep impacts in south Louisiana.</p>
            <p>We work in teams with climate scientists, engineers, geographers, sociologists, and data visualization experts to assess if, and to what extent, a given extreme weather event is more severe because of climate change.</p>
            <p>For Hurricane Ida, we compare and contrast three important time points. The first is 2021: the year of Hurricane Ida occurred. We identify the impacts to buildings and in economic damages.</p>
            <p>The second is 1971&mdash;fifty years <em>before</em> Ida. For this time point, we analyzed the storm again keeping everything the same like the location of buildings and extent of wetlands. But we changed one thing: the climate conditions. We set those to 1971, that is, a time before the world started to warm substantially. In this way, our 1971 model can be thought of as what the impacts of Hurricane Ida might have been in a world without climate change.</p>
            <p>The third time point is 2071&mdash;fifty years <em>after</em> Ida. The logic for 2071 is the same as 1971: we kept everything the same, but changed the climate conditions. This time, though, we looked to the future, not the past. Specifically, we studied what Hurricane Ida might look like in 2071 if the world continues to warm a few more degrees.</p>
            <p>Below, we will share data comparing and contrasting the 2021 storm that we experienced to the 1971 storm that would have occurred without the added impact of climate change, and the 2071 storm with greater impacts from climate change.</p>
            <h2>Extreme Event Attribution of Hurricane Ida</h2>
            <!-- <img src="images/placeholder-1.png" alt="example graph" /> -->
            <p id="intro-graph-title">Storm surge damages in three climate scenarios</p>
            <div id="intro-graph-container"><svg id="intro-graph"></svg></div>
            <p>In the graph above, we're looking at projected damage from flooding caused by storm surge under the three different climate time points: 1971, 2021, and 2071. For example, on the left, the graph shows that under 1971 climate conditions, we attribute just over $4.1 billion in damages to storm surge. In the middle, the 2021 bar reflects Ida as it actually occurred, with damages rising to over $4.3 billion. On the right, under 2071 climate projections, storm surge damage is expected to exceed $5 billion.</p>
            <p>By comparing 1971 and 2021, we found that damages from storm surge flooding were about 5% higher in Hurricane Ida because of climate change. We would anticipate that the storm would have 21% greater impacts if the climate continues to warm like for our 2071 time point.</p>
            <p>It's not just dollar damages either: we estimate that approximately 1,300 buildings were affected in 2021 that would not have been affected in a world without climate change. That number rises to approximately 6,000 more buildings in 2071.</p>
        </div>
    </div>


    <div class="textbox-background">
        <img src="images/background-2.jpg" alt="picture of coastal louisiana" />
        <div class="textbox-overlay">
            <h2>Impacts Where We Live</h2>
            <p>Using sophisticated flood models, we are able to analyze extreme event attribution impacts of Hurricane Ida not just for the whole storm, but localized impacts too.</p>
        </div>
    </div>

    <div class="visualization-container">
        <div class="visualization-prompt">
            <h2 class="poppins-light">What might
    
                <div class="dropdown">
                    <button class="dropdown-button">
                      <span id="map1-environmental-value" class="dropdown-value">storm surge flood damages in buildings</span>
                      <span class="arrow"></span>
                    </button>
                    <div id="map1-environmental-dropdown" class="environmental dropdown-content">
                        <!-- <span id="map1-wind-damages">wind damages</span> -->
                        <span class="selected-option" id="map1-storm-surge-#">storm surge flood damages in buildings</span>
                        <span id="map1-storm-surge-$">storm surge flood damages in dollars</span>
                    </div>
                </div>
                
                look like in
            
                <div class="dropdown">
                    <button class="dropdown-button">
                    <span id="map1-left-year-value" class="dropdown-value">1971</span>
                    <span class="arrow"></span>
                    </button>
                    <div id="map1-left-year-dropdown" class="dropdown-content">
                        <span id="map1-left-1971" class="selected-option">1971</span>
                        <span id="map1-left-2021">2021</span>
                        <span id="map1-left-2071">2071</span>
                    </div>
                </div>
                
                climatological conditions compared to in
    
                <div class="dropdown">
                    <button class="dropdown-button">
                    <span id="map1-right-year-value" class="dropdown-value">2021</span>
                    <span class="arrow"></span>
                    </button>
                    <div id="map1-right-year-dropdown" class="dropdown-content">
                        <span id="map1-right-1971">1971</span>
                        <span id="map1-right-2021" class="selected-option">2021</span>
                        <span id="map1-right-2071">2071</span>
                    </div>
                </div>
                ?
            </h2>
        </div>

        <div class="map-container">
            <div id="map1-census-toggle">
                <div class="map1-toggle-option active" id="map1-tract">census tract</div>
                <div class="map1-toggle-option" id="map1-block">census block</div>
            </div>

            <div id="map1" class="map">
            </div>
        </div>
    </div>

    <div class="textbox-background">
        <img src="images/background-3.jpg" alt="picture of coastal louisiana" />
        <div class="textbox-overlay">
            <h2>Impacts Across Society</h2>
            <p>We can also learn about the social make-up of those affected places.</p>
        </div>
    </div>

    <div class="visualization-container">
        <div class="visualization-prompt">
            <h2 class="poppins-light">What might 
    
                <div class="dropdown">
                    <button class="dropdown-button">
                      <span id="map2-environmental-dropdown-value" class="dropdown-value">storm surge flood damages in buildings</span>
                      <span class="arrow"></span>
                    </button>
                    <div id="map2-environmental-dropdown" class="environmental dropdown-content">
                        <!-- <span id="map2-wind-damages">wind damages</span> -->
                        <span class="selected-option" id="map2-storm-surge-#">storm surge flood damages in buildings</span>
                        <span id="map2-storm-surge-$">storm surge flood damages in dollars</span>
                    </div>
                </div>
                
                look like for people of different 
            
                <span class="force-break dropdown-wrapper"></span>
                <div class="dropdown">
                    <button class="dropdown-button">
                    <span id="map2-social-dropdown-value" class="dropdown-value">incomes</span>
                    <span class="arrow"></span>
                    </button>
                    <div id="map2-social-dropdown" class="social dropdown-content">
                        <span class="selected-option" id="incomes">incomes</span>
                        <span id="education-levels">education levels</span>
                        <span id="percent-minority">races</span>
                        <span id="percent-homeowners">home ownership</span>
                    </div>
                </div>
                
                in
    
                <div class="dropdown">
                    <button class="dropdown-button">
                    <span id="map2-years-dropdown-value" class="dropdown-value">2021</span>
                    <span class="arrow"></span>
                    </button>
                    <div id="map2-year-dropdown" class="dropdown-content">
                        <span id="map2-1971">1971</span>
                        <span id="map2-2021" class="selected-option">2021</span>
                        <span id="map2-2071">2071</span>
                    </div>
                </div>
                climatological conditions?
            </h2>
        </div>
        
        <div class="map-container">
            <div id="map2" class="map">
            </div>
        </div>
    </div>

    <div class="textbox-background">
        <img src="images/background-4.jpg" alt="picture of coastal louisiana" />
        <div class="textbox-overlay">
            <h2>Extreme Weather in a Changing Climate</h2>
            <p>Thank you for your engagement with this work, and we have a few questions to ask you about this research.</p>
        </div>
    </div>
</body>
</html>

<script>
    // ------------ SETUP FOR INTRO GRAPH ------------
    const graphData = [
        {year: "1971", damage: 4105417009}, 
        {year: "2021", damage: 4328088370},
        {year: "2071", damage: 5240759336}
    ];

    const graphContainer = d3.select("#intro-graph-container");
    const graphSVG = d3.select("#intro-graph")
    
    graphSVG.attr("width", graphContainer.node().offsetWidth);
    graphSVG.attr("height", graphContainer.node().offsetHeight);
    let graphWidth = graphSVG.attr("width");
    let graphHeight = graphSVG.attr("height");

    const graphMargin = { top: 10, right: 10, bottom: 40, left: 80 };

    const chartWidth = graphWidth - graphMargin.left - graphMargin.right;
    const chartHeight = graphHeight - graphMargin.top - graphMargin.bottom;

    const graphX = d3.scaleBand()
        .domain(graphData.map(d => d.year))
        .range([0, chartWidth])
        .padding(0.3);

    const graphY = d3.scaleLinear()
        .domain([0, 6000000000])
        .range([chartHeight, 0]);

    const chart = graphSVG.append("g")
        .attr("transform", `translate(${graphMargin.left},${graphMargin.top})`);

    chart.append("g")
        .attr("class", "y-axis")
        .call(d3.axisLeft(graphY).tickFormat(d => `$${(d / 1e9).toFixed(1)}B`));

    const yTicks = graphY.ticks(); 

    yTicks.forEach((tick, i) => {
        if (i % 2 === 0) {
            chart.append("line")
                .attr("x1", 0)
                .attr("x2", chartWidth)
                .attr("y1", graphY(tick))
                .attr("y2", graphY(tick))
                .attr("stroke", "#e5e3e3")
                .attr("stroke-width", 1);
        }
    });

    chart.append("line")
        .attr("x1", chartWidth)
        .attr("y1", 0)
        .attr("x2", chartWidth)
        .attr("y2", chartHeight)
        .attr("stroke", "#e5e3e3")
        .attr("stroke-width", 1);
    
    chart.append("text")
        .attr("class", "axis-label")
        .attr("text-anchor", "middle")
        .attr("transform", `rotate(-90)`)
        .attr("x", -chartHeight / 2)
        .attr("y", -graphMargin.left + 20)
        .text("Total Damage in USD");

    chart.append("g")
        .attr("transform", `translate(0,${chartHeight})`)
        .attr("class", "x-axis")
        .call(d3.axisBottom(graphX).tickPadding(10));

    chart.selectAll(".bar")
        .data(graphData)
        .enter()
        .append("rect")
        .attr("class", "bar")
        .attr("x", d => graphX(d.year))
        .attr("y", d => graphY(d.damage))
        .attr("width", graphX.bandwidth())
        .attr("height", d => chartHeight - graphY(d.damage));
</script>

<script>
    // ------------ SETUP FOR MAP 1: COMPARING ONE ENVIRONMENTAL VARIABLE BETWEEN YEARS ------------
    // base map
    var map1 = L.map('map1', {
        minZoom: 7,
        maxZoom: 14,
        maxBounds: [
        [26, -100.5],
        [35, -82.5]
        ],
        maxBoundsViscosity: 1,
        bounceAtZoomLimits: false
    }).setView([30, -91.5], 8);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd'
    }).addTo(map1);

    // properly center and expand map tiles on load
    setTimeout(function () {
        map1.invalidateSize();
    }, 100);

    // add comparator
    map1.createPane("left")
    map1.createPane("right")
    map1.createPane("labels")

    // add labels layer on top
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        pane: 'labels'
    }).addTo(map1);

    // ------------ MAP 1: initializing user options ------------
    let map1LeftLayer = null;
    let map1RightLayer = null;

    // referring to the options selected in the first visualization prompt
    const map1EnvironmentalDropdown = document.querySelector('#map1-environmental-dropdown');
    const map1LeftYearDropdown = document.querySelector('#map1-left-year-dropdown');
    const map1RightYearDropdown = document.querySelector('#map1-right-year-dropdown');

    let map1EnvironmentalOptions = {"map1-wind-damages": "wind", 
                                    "map1-storm-surge-$": "storm_$_",
                                    "map1-storm-surge-#": "storm_#_"};

    let map1Thresholds = {
        "storm_#_map1-tract": [1, 350, 700, 1050, 1400, 1750],
        "storm_#_map1-block": [1, 50, 100, 150, 200, 250],
        "storm_$_map1-tract": [1, 25000000, 50000000, 75000000, 100000000, 125000000],
        "storm_$_map1-block": [1, 10000000, 20000000, 30000000, 40000000, 50000000]
    }

    let map1LeftYearOptions = {"map1-left-1971": "1971", 
                               "map1-left-2021": "2021", 
                               "map1-left-2071": "2071"};

    let map1RightYearOptions = {"map1-right-1971": "1971", 
                                "map1-right-2021": "2021", 
                                "map1-right-2071": "2071"};

    let map1UserOptions = {
        map1EnvironmentalValue: map1EnvironmentalOptions[map1EnvironmentalDropdown.querySelector('.selected-option').id],
        map1LeftYearValue: map1LeftYearOptions[map1LeftYearDropdown.querySelector('.selected-option').id],
        map1RightYearValue: map1RightYearOptions[map1RightYearDropdown.querySelector('.selected-option').id]
    };

    var data1;
    var map1ColorScale;
    var map1LeftLegend;
    var map1RightLegend;
    var map1Comparator;
    const formatCommas = d3.format(",.0f");

    // ------------ MAP 1: user input event handlers ------------
    const map1Tract = document.getElementById('map1-tract');
    const map1Block = document.getElementById('map1-block');

    function setMap1ActiveCensus(option) {
        if (option === 'map1-tract') {
            map1Tract.classList.add('active');
            map1Block.classList.remove('active');
        } else {
            map1Block.classList.add('active');
            map1Tract.classList.remove('active');
        }
    }

    function getMap1SelectedCensus() {
        const activeElement = document.querySelector('.map1-toggle-option.active');
        return activeElement ? activeElement.id : null;
    }

    map1Tract.addEventListener('click', () => {
        setMap1ActiveCensus('map1-tract');
        loadMap1();
    });

    map1Block.addEventListener('click', () => {
        setMap1ActiveCensus('map1-block');
        loadMap1();
    });

    // ------------ MAP 1: data loading ------------
    async function loadMap1() {
        // fetch data file based on selected census level, then call function to render
        let censusLevel = getMap1SelectedCensus();
        let filePath = censusLevel === 'map1-tract' ? "storm_social_tract_cropped.geojson" : "storm_social_block_cropped.geojson";
        data1 = await d3.json(filePath, d3.autoType);
        renderMap1GeoJSON(data1);
    }

    function renderMap1GeoJSON(data) {
        // handle calls to styling to render the map
        let leftColumn = map1UserOptions.map1EnvironmentalValue + map1UserOptions.map1LeftYearValue;
        let rightColumn = map1UserOptions.map1EnvironmentalValue + map1UserOptions.map1RightYearValue;

        // let allMap1Values = data.features.flatMap(f => [
        //     Number(f.properties[leftColumn]),
        //     Number(f.properties[rightColumn])
        // ]);

        // let map1Extent = d3.extent(allMap1Values);        
        
        // console.log(map1ColorScale.quantiles());
        
        // map1ColorScale = d3.scaleQuantile().domain(map1Extent).range(['#dff3db', '#a8dcb5', '#4cb3d2', '#2c8cbd', '#084080']);
        // map1ColorScale = d3.scaleThreshold()
        //                     .domain([0, 50, 100, 150, 200, 250])
        //                     .range(['#f6fcf0', '#dff3db', '#a8dcb5', '#4cb3d2', '#2c8cbd', '#084080'])

        let thresholds = map1Thresholds[map1UserOptions.map1EnvironmentalValue + getMap1SelectedCensus()];

        map1ColorScale = d3.scaleThreshold()
                            .domain(thresholds)
                            .range(['#adadad', '#dff3db', '#a8dcb5', '#4cb3d2', '#2c8cbd', '#084080']);

    //    map1ColorScale =  d3.scaleQuantile().domain(allMap1Values).range(d3.schemeGnBu[5])

        // map1ColorScale = d3.scaleSequential(d3.interpolateGnBu).domain(map1Extent).exponent(0.3);

    //     map1ColorScale = d3.scaleLinear()
    // .domain([0, 700])
    // .range([0, 1])
    // .interpolate(() => d3.interpolateGnBu);
        

        if (map1LeftLayer) {
            map1.removeLayer(map1LeftLayer);
        }
        if (map1RightLayer) {
            map1.removeLayer(map1RightLayer);
        }
        if (map1Comparator) {
            map1.removeControl(map1Comparator);
        }
        if (map1LeftLegend) {
            map1.removeControl(map1LeftLegend);
        };
        if (map1RightLegend) {
            map1.removeControl(map1RightLegend);
        };

        map1LeftLayer = L.geoJSON(data, { 
            style: feature => getMap1LeftStyle(feature),
            pane: 'left',
            onEachFeature: showMap1Popup
            
        }).addTo(this.map1);

        map1RightLayer = L.geoJSON(data, { 
            style: feature => getMap1RightStyle(feature),
            pane: 'right',
            onEachFeature: showMap1Popup
        }).addTo(this.map1);

        map1Comparator = L.control.sideBySide([], []).addTo(this.map1);
        map1Comparator.setLeftLayers(map1LeftLayer);
        map1Comparator.setRightLayers(map1RightLayer);  

        map1LeftLegend = createMap1Legends(map1, 'left');
        map1RightLegend = createMap1Legends(map1, 'right');
    }

    function getMap1LeftStyle(feature) {
        let value = feature.properties[map1UserOptions.map1EnvironmentalValue + map1UserOptions.map1LeftYearValue];
        
        return {
            color: 'white', 
            weight: getMap1SelectedCensus() == 'map1-tract' ? 1 : 0.5, 
            fillOpacity: 0.98,
            fillColor: map1ColorScale(value)
        }
    }

    function getMap1RightStyle(feature) {
        let value = feature.properties[map1UserOptions.map1EnvironmentalValue + map1UserOptions.map1RightYearValue];
        
        return {
            color: 'white', 
            weight: getMap1SelectedCensus() == 'map1-tract' ? 1 : 0.5, 
            fillOpacity: 0.98,
            fillColor: map1ColorScale(value)
        }
    }

    function createMap1Legends(map, position) {
        let legendPosition = position === 'left' ? 'bottomleft' : 'bottomright';

        const legend = L.control({ position: legendPosition });

        legend.onAdd = function () {
            const div = L.DomUtil.create('div', `map1 info legend ${position}`);
            div.innerHTML = generateMap1LegendHTML(position);
            return div;
        };

        legend.update = function (position) {
            const div = document.querySelector(`.map1.info.legend.${position}`);

            if (div) {
                div.innerHTML = generateMap1LegendHTML(position);
            }
        };

        legend.addTo(map);
        return legend;
    }

    function generateMap1LegendHTML(position) {
       
        let placeholder2071 = position === 'left' ? map1UserOptions.map1LeftYearValue == 2071 : map1UserOptions.map1RightYearValue == 2071;
        let placeholderWind = map1UserOptions.map1EnvironmentalValue == "wind";
        let placeholder1971 = position === 'left' ? map1UserOptions.map1LeftYearValue == 1971 && map1UserOptions.map1EnvironmentalValue == "storm_$_": map1UserOptions.map1RightYearValue == 1971 && map1UserOptions.map1EnvironmentalValue == "storm_$_";

        let thresholds = map1Thresholds[map1UserOptions.map1EnvironmentalValue + getMap1SelectedCensus()];

        map1ColorScale.domain(thresholds);

        let classes = map1ColorScale.domain(),
        labels = [];

        let title = map1UserOptions.map1EnvironmentalValue == "storm_#_" ? 
            "Estimated # of Affected Buildings" : 
            "Estimated $ Damages";

        let innerContent = position === 'left' ? 
            `<p class="legend-title">${title} in ${map1UserOptions.map1LeftYearValue} Climate</p>` : 
            `<p class="legend-title">${title} in ${map1UserOptions.map1RightYearValue} Climate</p>`;
        
        if (classes[0] === undefined || classes[1] == 0 || placeholder2071 || placeholderWind || placeholder1971) {
            innerContent += `<p>No data available</p>`
        } else {
            innerContent += '<i style="background:' + map1ColorScale(0) + '"></i> ' + '0' + '<br>';
            for (let i = 1; i < 6; i++) {
                let from = i === 0 ? 0 : classes[i-1];
                let to = classes[i] !== undefined ? classes[i] : classes[5];

                innerContent += '<i style="background:' + map1ColorScale(from) + '"></i> ' +
                    formatCommas(from) + (to !== classes[5] ? ' &ndash; ' + formatCommas(to - 1) : '+') + '<br>';
            }
        }
        return innerContent;
    }

    function updateMap1UserOptions(newOptions) {
        map1UserOptions = { ...map1UserOptions, ...newOptions };
        if (map1LeftLegend) {
            map1LeftLegend.update('left');
        }
        if (map1RightLegend) {
            map1RightLegend.update('right');
        }
        if (map1LeftLayer) {
            map1LeftLayer.setStyle(getMap1LeftStyle);
        };
        if (map1RightLayer) {
            map1RightLayer.setStyle(getMap1RightStyle);
        };
    }
    loadMap1();

    // function showCustomPopup(feature, layer) {
    
    //     layer.bindPopup(feature.properties.NAMELSADCO);
    // }
    var currentlyHighlightedLayer = null;

    function highlightFeature(e) {
       
    }

    function showMap1Popup(feature, layer) {

        let title = getMap1SelectedCensus() == 'map1-tract' ? feature.properties.NAMELSADCO : feature.properties.NAME20;

        layer.bindPopup("<h3>" + 
            title + 
            "</h3> <p> Buildings Affected in 1971: " + feature.properties['storm_#_1971'] +
            "</p><p> Buildings Affected in 2021: " + feature.properties['storm_#_2021'] +
            "</p><p> Buildings Affected in 2071: no data </p>"

            //     "<p>Population: " + feature.properties.total_popu + 
            // "</p><p> Median Income: $" + formatCommas(feature.properties.median_inc) + 
            // "</p><p> College Educated: " + Math.round(feature.properties.college_de * 100) / 100 + 
            // "%</p>"
            
        );
        
        layer.on({
            click: highlightFeature
        });
    }
</script>

<script>
    // ------------ SETUP FOR MAP 2: COMPARING ONE ENVIRONMENTAL VARIABLE AND ONE SOCIAL VARIABLE IN ONE YEAR ------------
    // base map
    var map2 = L.map('map2', {
        minZoom: 7,
        maxZoom: 14,
        maxBounds: [
        [26, -100.5],
        [35, -82.5]
        ],
        maxBoundsViscosity: 1,
        bounceAtZoomLimits: false
    }).setView([30, -91.5], 8);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd'
    }).addTo(map2);

    // properly center and expand map tiles on load
    setTimeout(function () {
        map2.invalidateSize();
    }, 100);

    // add comparator
    map2.createPane("left")
    map2.createPane("right")
    map2.createPane("labels")

    // add labels layer on top
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        pane: 'labels'
    }).addTo(map2);

    // ------------ MAP 2: initializing user options ------------
    let map2LeftLayer = null;
    let map2RightLayer = null;

    // referring to the options selected in the first visualization prompt
    const map2EnvironmentalDropdown = document.querySelector('#map2-environmental-dropdown');
    const map2SocialDropdown = document.querySelector('#map2-social-dropdown');
    const map2YearDropdown = document.querySelector('#map2-year-dropdown');

    let map2EnvironmentalOptions = {"map2-wind-damages": "wind", 
                                    "map2-storm-surge-$": "storm_$_",
                                    "map2-storm-surge-#": "storm_#_"};

    let map2SocialOptions = {"incomes": "median_inc",
                             "education-levels": "college_de",
                             "percent-minority": "nonwhite_t",
                             "percent-homeowners": "owner_occu"};
    
    let map2Thresholds = {
        "storm_#_1971": [1, 350, 700, 1050, 1400, 1750],
        "storm_#_2021": [1, 350, 700, 1050, 1400, 1750],
        "storm_#_2071": [1, 350, 700, 1050, 1400, 1750],
        "storm_$_1971": [1, 25000000, 50000000, 75000000, 100000000, 125000000],
        "storm_$_2021": [1, 10000000, 20000000, 30000000, 40000000, 50000000],
        "storm_$_2071": [1, 10000000, 20000000, 30000000, 40000000, 50000000],
        "median_inc": [5000, 40000, 75000, 110000, 145000],
        "college_de": [1, 15, 30, 45, 60],
        "nonwhite_t": [0, 20, 40, 60, 80],
        "owner_occu": [5, 25, 45, 65, 85]
    }


    let map2YearOptions = {"map2-1971": "1971",
                            "map2-2021": "2021",
                            "map2-2071": "2071"};

    let map2UserOptions = {
        map2EnvironmentalValue: map2EnvironmentalOptions[map2EnvironmentalDropdown.querySelector('.selected-option').id],
        map2SocialValue: map2SocialOptions[map2SocialDropdown.querySelector('.selected-option').id],
        map2YearValue: map2YearOptions[map2YearDropdown.querySelector('.selected-option').id]
    };

    var data2;
    var map2EnvironmentalColorScale;
    var map2SocialColorScale;
    var map2LeftLegend;
    var map2RightLegend;
    var map2Comparator;

    let socialTitles = {
            "median_inc": "Median Income in $",
            "college_de": "% of Population with College Degree",
            "nonwhite_t": "% Minority",
            "owner_occu": "% Homeowners"
    };

    let socialPopup = {
            "median_inc": "Median Income: $",
            "college_de": "Percent of Population with College Degree: ",
            "nonwhite_t": "Percent Minority: ",
            "owner_occu": "Percent Homeowners: "
    };

    // ------------ MAP 2: data loading ------------
    async function loadMap2() {
        let filePath = "storm_social_tract_uncropped.geojson";
        data2 = await d3.json(filePath, d3.autoType);
        renderMap2GeoJSON(data2);
    }

    function renderMap2GeoJSON(data) {
        // handle calls to styling to render the map
        // let leftColumn = map2UserOptions.map2EnvironmentalValue + map2UserOptions.map2YearValue;
        // let rightColumn = map2UserOptions.map2SocialValue;

        // let map2EnvironmentalExtent = d3.extent(data.features, d => Number(d.properties[leftColumn]));
        // let map2SocialExtent = d3.extent(data.features, d => Number(d.properties[rightColumn]));
        
        // map2EnvironmentalColorScale = d3.scaleQuantile().domain(map2EnvironmentalExtent).range(['#dff3db', '#a8dcb5', '#4cb3d2', '#2c8cbd', '#084080']);
        // map2SocialColorScale = d3.scaleQuantile().domain(map2SocialExtent).range(d3.schemeYlOrBr[6].slice(1));

        let socialThresholds = map2Thresholds[map2UserOptions.map2SocialValue];

        map2SocialColorScale = d3.scaleThreshold()
                            .domain(socialThresholds)
                            .range(d3.schemeYlOrBr[6]);

        let environmentalThresholds = map2Thresholds[map2UserOptions.map2EnvironmentalValue + map2UserOptions.map2YearValue];

        map2EnvironmentalColorScale = d3.scaleThreshold()
                            .domain(environmentalThresholds)
                            .range(['#adadad', '#dff3db', '#a8dcb5', '#4cb3d2', '#2c8cbd', '#084080']);

        if (map2LeftLayer) {
            map2.removeLayer(map2LeftLayer);
        }
        if (map2RightLayer) {
            map2.removeLayer(map2RightLayer);
        }
        if (map2Comparator) {
            map2.removeControl(map2Comparator);
        }
        if (map2LeftLegend) {
            map2.removeControl(map2LeftLegend);
        };
        if (map2RightLegend) {
            map2.removeControl(map2RightLegend);
        };

        map2LeftLayer = L.geoJSON(data, { 
            style: feature => getMap2LeftStyle(feature),
            pane: 'left',
            onEachFeature: showMap2Popup
        }).addTo(this.map2);

        map2RightLayer = L.geoJSON(data, { 
            style: feature => getMap2RightStyle(feature),
            pane: 'right',
            onEachFeature: showMap2Popup
        }).addTo(this.map2);

        map2Comparator = L.control.sideBySide([], []).addTo(this.map2);
        map2Comparator.setLeftLayers(map2LeftLayer);
        map2Comparator.setRightLayers(map2RightLayer);  

        map2LeftLegend = createMap2Legends(map2, 'left');
        map2RightLegend = createMap2Legends(map2, 'right');
    }

    function getMap2LeftStyle(feature) {
        let value = feature.properties[map2UserOptions.map2EnvironmentalValue + map2UserOptions.map2YearValue];
        
        return {
            color: 'white', 
            weight: 1, 
            fillOpacity: 0.98,
            fillColor: value == null ? 'transparent' : map2EnvironmentalColorScale(value)
        }
    }

    function getMap2RightStyle(feature) {
        let value = feature.properties[map2UserOptions.map2SocialValue];
        
        return {
            color: 'white', 
            weight: 1, 
            fillOpacity: 0.98,
            fillColor: value == null ? 'transparent' : map2SocialColorScale(value)
        }
    }

    function createMap2Legends(map, position) {
        let legendPosition = position === 'left' ? 'bottomleft' : 'bottomright';

        const legend = L.control({ position: legendPosition });

        legend.onAdd = function () {
            const div = L.DomUtil.create('div', `map2 info legend ${position}`);
            div.innerHTML = generateMap2LegendHTML(position);
            return div;
        };

        legend.update = function (position) {
            const div = document.querySelector(`.map2.info.legend.${position}`);
      
            if (position === 'left') {
                let environmentalThresholds = map2Thresholds[map2UserOptions.map2EnvironmentalValue + map2UserOptions.map2YearValue];
                map2EnvironmentalColorScale.domain(environmentalThresholds);
            } else {
                let socialThresholds = map2Thresholds[map2UserOptions.map2SocialValue];
                map2SocialColorScale.domain(socialThresholds)
            }
            
            if (div) {
                div.innerHTML = generateMap2LegendHTML(position);
            }
        };

        legend.addTo(map);
        return legend;
    }

    function generateMap2LegendHTML(position) {
        let colorScale = position === 'left' ? map2EnvironmentalColorScale : map2SocialColorScale;
        
        let classes = colorScale.domain(),
        labels = [];

        let column = position === 'left' ? map2UserOptions.map2EnvironmentalValue + map2UserOptions.map2YearValue : map2UserOptions.map2SocialValue;

        let title = map2UserOptions.map2EnvironmentalValue == "storm_#_" ? 
            "Estimated # of Affected Buildings" : 
            "Estimated $ Damages";

        let innerContent;

        if (position === 'left') {
            innerContent = `<p class="legend-title">${title} in ${map2UserOptions.map2YearValue} Climate</p>`;
        } else {
            innerContent = `<p class="legend-title">${socialTitles[map2UserOptions.map2SocialValue]}</p>`;
        }

        if (classes[0] === undefined || classes[1] == 0) {
            innerContent += `<p>No data available</p>`
        } else {
            if (position === 'left') {
                innerContent += '<i style="background:' + colorScale(0) + '"></i> ' + '0' + '<br>';
            } 
            for (let i = 1; i < 6; i++) {
                let from = i === 0 ? classes[0] : classes[i-1];
                let to = classes[i] !== undefined ? classes[i] : classes[5];

                innerContent += '<i style="background:' + colorScale(from) + '"></i> ' +
                formatCommas(from) + (to !== classes[5] ? ' &ndash; ' +  formatCommas(to - 1) : '+') + '<br>';
            }
        }
        return innerContent;
    }

    function updateMap2UserOptions(newOptions) {
        map2UserOptions = { ...map2UserOptions, ...newOptions };
        if (map2LeftLegend) {
            map2LeftLegend.update('left');
        }
        if (map2RightLegend) {
            map2RightLegend.update('right');
        }
        if (map2LeftLayer) {
            map2LeftLayer.setStyle(getMap2LeftStyle);
        };
        if (map2RightLayer) {
            map2RightLayer.setStyle(getMap2RightStyle);
        };
    }

    function showMap2Popup(feature, layer) {
        let title = feature.properties.NAMELSADCO;

        layer.bindPopup("<h3>" + 
            title + 
            "</h3> <p> Buildings Affected in 1971: " + feature.properties['storm_#_1971'] +
            "</p><p> Buildings Affected in 2021: " + feature.properties['storm_#_2021'] +
            "</p><p> Buildings Affected in 2071: no data </p>" +
            "<p>Population: " + feature.properties.total_popu + 
            "</p><p> Median Income: " + `${feature.properties.median_inc ? '$' + formatCommas(feature.properties.median_inc) : 'no data'}` +
            "</p><p> Percent College Educated: " + `${feature.properties.college_de ? Math.round(feature.properties.college_de * 100) / 100 + '%': " no data"}` +
            "</p><p> Percent Minority: " + `${feature.properties.nonwhite_t ? Math.round(feature.properties.nonwhite_t * 100) / 100 + '%': " no data"}` +
            "</p><p> Percent Homeowners: " + `${feature.properties.owner_occu ? Math.round(feature.properties.owner_occu * 100) / 100 + '%': " no data"}` +
            "</p>"
        );

        layer.on({
            click: highlightFeature
        });
    }
    loadMap2();
</script>

<script>
    // handling dropdowns
    // ------------ DROPDOWN INTERACTION SETUP ------------
    document.querySelectorAll('.dropdown').forEach(dropdown => {
        const dropdownButton = dropdown.querySelector('.dropdown-button');
        const dropdownContent = dropdown.querySelector('.dropdown-content');
        const dropdownOptions = [...dropdown.querySelectorAll('.dropdown-content span')];
        const dropdownArrow = dropdown.querySelector('.arrow');
        const dropdownValue = dropdown.querySelector('.dropdown-value');

        // Handling when dropdown filter chip is clicked
        dropdownButton.addEventListener('click', (event) => {
            const isVisible = dropdownContent.style.display === 'block';
            dropdownContent.style.display = isVisible ? 'none' : 'block';
            dropdownArrow.classList.toggle("active");
        });

        const setDropdownWidth = () => {
            const buttonWidth = dropdownButton.offsetWidth;
            dropdownContent.style.minWidth = `${buttonWidth}px`;
            dropdownContent.style.width = `${buttonWidth}px`;
        };

        addEventListener("load", function () {
            setDropdownWidth();
        })
       
        // Handling when a dropdown option is selected
        dropdownContent.addEventListener('click', (event) => {
            const target = event.target;
            if (target.tagName.toLowerCase() === 'span') {
                let newValue = target.innerHTML;
                dropdownValue.innerHTML = newValue;
                dropdownOptions.forEach((option) => option.classList.remove("selected-option"));
                target.classList.add("selected-option");
                setDropdownWidth();
               
                updateMap1UserOptions({
                    map1EnvironmentalValue: map1EnvironmentalOptions[map1EnvironmentalDropdown.querySelector('.selected-option').id],
                    map1LeftYearValue: map1LeftYearOptions[map1LeftYearDropdown.querySelector('.selected-option').id],
                    map1RightYearValue: map1RightYearOptions[map1RightYearDropdown.querySelector('.selected-option').id],
                });

                updateMap2UserOptions({
                    map2EnvironmentalValue: map2EnvironmentalOptions[map2EnvironmentalDropdown.querySelector('.selected-option').id],
                    map2SocialValue: map2SocialOptions[map2SocialDropdown.querySelector('.selected-option').id],
                    map2YearValue: map2YearOptions[map2YearDropdown.querySelector('.selected-option').id]
                });
            }
        });

        // close dropdown if clicked outside
        window.addEventListener('click', (event) => {
            if (!dropdown.contains(event.target)) {
                if (dropdownContent.style.display === 'block') {
                    dropdownContent.style.display = 'none';
                    dropdownArrow.classList.remove("active");
                }
            }
        });
    });
</script>